<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-/mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.DreamBook.BookStoreService.mapper.review.ReviewMapper">



    <select id="maxNum" resultType="int">
        select nvl(max(reviewId),0) from review
    </select>




    <insert id="insertReviewData" parameterType="com.DreamBook.BookStoreService.dto.review.ReviewAddDTO">

        insert into review(reviewId,memberId,bookId,orderId,reviewSubject,reviewContent,reviewFileName,reviewFilePath,
                           grade,views,reviewDate)
        values (#{reviewId},#{memberId},#{bookId},#{orderId},#{reviewSubject},#{reviewContent},#{reviewFileName},
                #{reviewFilePath},#{grade},0,SYSDATE)

    </insert>

    <insert id="insertReviewDataNotImg" parameterType="com.DreamBook.BookStoreService.dto.review.ReviewAddDTO">

        insert into review(reviewId,memberId,bookId,orderId,reviewSubject,reviewContent,reviewFileName,reviewFilePath,
                           grade,views,reviewDate)
        values (#{reviewId},#{memberId},#{bookId},#{orderId},#{reviewSubject},#{reviewContent},'',
                '' ,#{grade},0,SYSDATE)

    </insert>

    <select id="ReviewOrderIdFind"  resultType="Integer"
            parameterType="int">

        select  nvl(max(orderId),0) from review

        where orderId = #{orderId}

    </select>


    <select id="ReviewCheck"  resultType="com.DreamBook.BookStoreService.dto.review.ReviewFindDTO"
          >

        SELECT reviewId from review

        WHERE orderId IN
        <foreach item="orderId" collection="orderId" open="(" close=")" separator=",">
            #{orderId.orderId}
        </foreach>


    </select>


    <select id="reviewAllList"  resultType="com.DreamBook.BookStoreService.dto.review.ReviewFindDTO">

        SELECT  *
        FROM (
        SELECT  ROW_NUMBER() OVER(ORDER by a.reviewDate desc) AS
        row_num,
        a.reviewId, c.userId, a.bookId,a.memberId,a.reviewSubject,a.reviewContent,a.reviewFileName,b.bookName,b.genre,b.PUBLISHER,b.author,a.reviewDate,b.price,round(AVG(a.grade))as grade,count(a.reviewId) as reviewIdCount
        from review a

        left join book b on a.bookId = b.bookId

        left join  member c
        on a.memberId = c.memberId


        GROUP BY a.reviewId,c.userId, a.bookId,a.reviewSubject,a.reviewContent,a.reviewFileName,b.bookName,a.memberId,b.price,b.genre,b.PUBLISHER,b.author,a.reviewDate


        )
        <if test="firstRecordIndex !=null and lastRecordIndex != null">
            WHERE row_num > #{firstRecordIndex} AND
            #{lastRecordIndex} >=row_num
        </if>

    </select>

    <select id="reviewBookList"  resultType="com.DreamBook.BookStoreService.dto.review.ReviewFindDTO">

        SELECT  *
        FROM (
        SELECT  ROW_NUMBER() OVER(ORDER by a.reviewDate desc) AS
        row_num,
        a.reviewId, c.userId, a.bookId,a.memberId,a.reviewSubject,a.reviewContent,a.reviewFileName,b.bookName,b.genre,b.PUBLISHER,b.author,a.reviewDate,b.price,round(AVG(a.grade))as grade,count(a.reviewId) as reviewIdCount
        from review a

        left join book b on a.bookId = b.bookId

        left join  member c
        on a.memberId = c.memberId


        GROUP BY a.reviewId,c.userId, a.bookId,a.reviewSubject,a.reviewContent,a.reviewFileName,b.bookName,a.memberId,b.price,b.genre,b.PUBLISHER,b.author,a.reviewDate


        )
        <if test="firstRecordIndex !=null and lastRecordIndex != null">
            WHERE row_num > #{firstRecordIndex} AND
            #{lastRecordIndex} >=row_num
        </if>

    </select>




    <select id="reviewDetailList" parameterType="int" resultType="com.DreamBook.BookStoreService.dto.review.ReviewFindDTO">
        select * from review a
                          left join  book b
                                     on a.bookId = b.bookId
        where a.reviewId = #{reviewId}
    </select>


    <select id="reviewWriter" resultType="com.DreamBook.BookStoreService.dto.review.ReviewFindDTO">
        select * from review a
                 left join  member b
                 on a.memberId = b.memberId


--
    </select>

    <select id="myOrderReviewCheck" resultType="com.DreamBook.BookStoreService.dto.order.OrderDTO">

        SELECT * from review a

        left join  orders b
        on a.orderId = b.orderId

        WHERE a.orderId IN
        <foreach item="orderDTO" collection="orderDTO" open="(" close=")" separator=",">
            #{orderDTO.orderId}
        </foreach>

        and a.bookId in

        <foreach item="orderDTO" collection="orderDTO" open="(" close=")" separator=",">
            #{orderDTO.bookId}
        </foreach>





--
    </select>


<!--    <select id="reviewBookList" parameterType="int" resultType="com.DreamBook.BookStoreService.dto.review.ReviewFindDTO">-->

<!--        SELECT a.reviewId,c.userId, a.bookId,a.memberId,a.reviewSubject,a.reviewContent,a.reviewFileName,b.bookName,b.genre,b.PUBLISHER,b.author,b.price,a.grade,count(a.reviewId) as reviewIdCount-->
<!--        from review a-->

<!--                 left join book b on a.bookId = b.bookId-->

<!--                 left join  member c-->
<!--                            on a.memberId = c.memberId-->



<!--        where a.bookId = #{bookId}-->

<!--        GROUP BY a.reviewId,c.userId, a.bookId,a.reviewSubject,a.reviewContent,a.reviewFileName,b.bookName,a.memberId,a.grade,b.price,b.genre,b.PUBLISHER,b.author-->




<!--&#45;&#45;-->
<!--    </select>-->

<!--    <select id="reviewMemberList" parameterType="int" resultType="com.DreamBook.BookStoreService.dto.review.ReviewFindDTO">-->

<!--      select  *  from orders a-->
<!--        left join book b on a.bookId = b.bookId-->
<!--        left join review c on b.bookId = c.bookId-->




<!--                 where a.bookId in-->

<!--        <foreach item="orderDTOList" collection="orderDTOList" open="(" close=")" separator=",">-->
<!--            #{orderDTOList.bookId}-->
<!--        </foreach>-->

<!--      and a.memberId in <foreach item="orderDTOList" collection="orderDTOList" open="(" close=")" separator=",">-->
<!--        #{orderDTOList.memberId}-->
<!--    </foreach>-->





<!--        &#45;&#45;-->
<!--    </select>-->




    <update id="updateReviewData" parameterType="com.DreamBook.BookStoreService.dto.review.ReviewUpdateDTO">

    update review
    set reviewSubject= #{reviewSubject},reviewContent=#{reviewContent},reviewFileName =#{reviewFileName},
        reviewFilePath= #{reviewFilePath},grade=#{grade}

    where reviewId = #{reviewId}

    </update>

    <update id="updateReviewDataNotImage" parameterType="com.DreamBook.BookStoreService.dto.review.ReviewUpdateDTO">

        update review
        set reviewSubject= #{reviewSubject},reviewContent=#{reviewContent},grade=#{grade}

        where reviewId = #{reviewId}

    </update>

    <delete id="deleteReview" parameterType="com.DreamBook.BookStoreService.dto.review.ReviewDeleteDTO">

       delete from review

       where reviewId = #{reviewId}

    </delete>






<!--    where b.memberId in #{memberId}-->

<!--    <select id="bookReviewList" resultType="com.DreamBook.BookStoreService.dto.review.ReviewFindDTO">-->
<!--        select AVG(b.grade),a.* from book a-->
<!--                                     LEFT JOIN review b ON-->
<!--            a.bookId = b.bookId-->
<!--        where a.bookId = 1;-->
<!--    </select>-->





<!--    <select id="maxNum" resultType="int">-->
<!--        select nvl(max(orderId),0) from orders-->
<!--    </select>-->





<!--    <insert id="orderInsertData" parameterType="com.DreamBook.BookStoreService.dto.order.OrderDTO">-->
<!--        <foreach item="item" index="index" collection="java.util.List" separator=" " open="INSERT ALL " close="SELECT * FROM DUAL">-->
<!--           INSERT INTO orders(orderId,memberId,bookId,orderNum,impUid,amount,orderState,orderDate,usePoint)-->
<!--            VALUES (#{item.orderId},#{item.memberId},#{item.bookId},#{item.orderNum},-->
<!--           #{item.impUid},#{item.amount},'ORDER',SYSDATE,#{item.usePoint})-->
<!--        </foreach>-->
<!--    </insert>-->

<!--    <insert id="orderInsertData" parameterType="com.DreamBook.BookStoreService.dto.order.OrderDTO">-->

<!--        insert into orders(orderId,memberId,bookId,orderNum,impUid,amount,orderState,orderDate,usePoint)-->
<!--            VALUES (#{orderId},#{memberId},#{bookId},#{orderNum},-->
<!--            #{impUid},#{amount},'ORDER',SYSDATE ,#{usePoint})-->


<!--    </insert>-->

<!--    <insert id="deliveryInsertData" parameterType="com.DreamBook.BookStoreService.dto.order.DeliveryDTO">-->

<!--        insert into DELIVERY(deliveryId,orderId,recipient,deliveryTel,postcode,address,detailAddress,extraAddress,deliveryCost)-->
<!--        VALUES (#{deliveryId},#{orderId},#{recipient},#{deliveryTel},-->
<!--                #{postcode},#{address},#{detailAddress},#{extraAddress},#{deliveryCost})-->


<!--    </insert>-->

<!--    <select id="orderList"  resultType="com.DreamBook.BookStoreService.dto.order.OrderDTO"-->
<!--            parameterType="String">-->
<!--        select * from orders-->
<!--        where orderNum = #{orderNum}-->



<!--    </select>-->

<!--    <select id="orderFindList"  resultType="com.DreamBook.BookStoreService.dto.order.OrderDTO"-->
<!--            parameterType="int">-->
<!--        select distinct orderNum,orderState from orders-->
<!--        where memberId = #{memberId}-->



<!--    </select>-->


<!--    <select id="orderIdList" resultType="com.DreamBook.BookStoreService.dto.order.OrderDTO">-->
<!--        SELECT distinct orderNum, bookId from orders-->

<!--        WHERE orderNum IN-->
<!--        <foreach item="list" collection="list" open="(" close=")" separator=",">-->
<!--            #{list.orderNum}-->
<!--        </foreach>-->
<!--        order by orderNum-->

<!--    </select>-->



<!--    <select id="orderListOrderState" resultType="com.DreamBook.BookStoreService.dto.order.OrderDTO">-->
<!--        SELECT distinct  orderState  from orders a-->
<!--        left join book b on a.bookId = b.bookId-->


<!--        WHERE a.orderNum IN-->
<!--        <foreach item="list" collection="list" open="(" close=")" separator=",">-->
<!--            #{list.orderNum}-->
<!--        </foreach>-->



<!--    </select>-->



</mapper>
